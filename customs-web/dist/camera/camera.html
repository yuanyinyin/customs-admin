<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <title>南通市口岸视频监控</title>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <!-- <link rel="stylesheet" type="text/css" href="jsp/qjzs/qjzs_sxt/js/main.css"> -->
    <script src="js/hikJs/jquery-1.12.4.min.js"></script>
    <script src="laydate/laydate.js"></script>
    <script src="js/hikJs/jsWebControl-1.0.0.min.js"></script>
    <script src="js/hikJs/jsencrypt.min.js"></script>
    <script src="js/drawMixin.js"></script>
    <script src="js/scroll.js"></script>
    <script src="js/main.js"></script>
</head>

<body>
<div class="app">
    <div class="container new" id="container">
        <div class="header">
            <div class="textTitle"><span>南通市口岸视频监控</span></div>
            <div class="date" id="date"></div>
        </div>
        <div class="specialMain">
            <div class="frame">
                <div id="videoDiv" style="float:left;width:39%;height: 50%;">
                    <div id="contentVideo"></div>
                </div>
                <div class="frameSidebarRight">
                    <div class="showBox">
                        <div class="decorate lt"></div>
                        <div class="decorate rt"></div>
                        <div class="sidebarTitle"><img src="images/right_title_bg.png" alt=""></div>
                        <div class="sidebarCon">
                            <div class="sidebarSubTitle">
                                <h2>视频播放</h2>
                                <div class="switch"><img src="images/up.png" alt=""></div>
                            </div>
                            <div class="sidebarSubCon alinksBox">
                                <a href="#" id="videoId" class="current" onclick="playVideo()">播放实时</a>
                                <a href="#" id="recordId" class="" onclick="playRecord()">播放录像</a>
                            </div>
                        </div>

                        <div class="sidebarCon dateController">
                            <h3>开始时间</h3>
                            <div class="dateContainer">
                                <div class="dateInputBox">
                                    <div class="dateIcon"><img src="images/rili.png" alt=""></div>
                                    <div class="dateInput" id="showStartDate"></div>
                                    <div class="calendarBox" id="calendarOne">
                                        <span id="startDate"></span>
                                    </div>
                                </div>
                                <div class="timeInputBox">
                                    <div class="timeInput" id="showStartTime"></div>
                                    <div class="calendarBox" id="calendarTwo">
                                        <span id="startTime"></span>
                                    </div>
                                </div>
                            </div>

                            <h3>结束时间</h3>
                            <div class="dateContainer">
                                <div class="dateInputBox">
                                    <div class="dateIcon"><img src="images/rili.png" alt=""></div>
                                    <div class="dateInput" id="showEndDate"></div>
                                    <div class="calendarBox" id="calendarThree">
                                        <span id="endDate"></span>
                                    </div>
                                </div>
                                <div class="timeInputBox">
                                    <div class="timeInput" id="showEndTime"></div>
                                    <div class="calendarBox" id="calendarFour">
                                        <span id="endTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebarCon" style="height:260px;">
                            <div class="sidebarSubTitle">
                                <h2>监控源</h2>
                                <div class="switch">
                                    <img src="${ctx}/images/up.png" alt="">
                                </div>
                            </div>
                            <div class="sidebarSubCon">
                                <div class="sidebarSubCon alinksBox">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer"></div>
    </div>
</div>
<script type="text/javascript">
    var startYear, startMonth, startDay, startHour, startMinute, startSecond
    var endYear, endMonth, endDay, endHour, endMinute, endSecond

    function getQueryVariable(variable){
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
            var pair = vars[i].split("=");
            if(pair[0] == variable){return pair[1];}
            }
            return(false);
    }

    function getDateTime() {
        var dateObj = new Date(); //表示当前系统时间的Date对象
        var year = dateObj.getFullYear(); //当前系统时间的完整年份值
        var month = dateObj.getMonth() + 1; //当前系统时间的月份值
        var date = dateObj.getDate(); //当前系统时间的月份中的日
        var day = dateObj.getDay(); //当前系统时间中的星期值
        var weeks = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
        var week = weeks[day]; //根据星期值，从数组中获取对应的星期字符串
        $("#date").html(year + "年" + dateFilter(month) + "月" + dateFilter(date) + "日 " + week);
    }

    // 年月日不满10位的前面补0
    function dateFilter(date) {
        if (date < 10) {
            return "0" + date;
        }
        return date;
    }

    $(function () {
        getDateTime();
        //收缩显示框
        $(".sidebarSubTitle .switch").click(function () {
            if ($(this).hasClass("current")) {
                $(this).parent().next().show();
                $(this).removeClass("current");
            } else {
                $(this).parent().next().hide();
                $(this).addClass("current");
            }
        });
        //选择时间及日期
        $('.dateInputBox').click(function () {
            if ($(this).find(".calendarBox").is(':hidden')) {
                $(this).find(".calendarBox").show();
            } else {
                $(this).find(".calendarBox").hide();
            }
            return false
        });
        $('.timeInputBox').click(function () {
            if ($(this).find(".calendarBox").is(':hidden')) {
                $(this).find(".calendarBox").show();
            } else {
                $(this).find(".calendarBox").hide();
            }
            return false
        });
        $(document.body).click(function () {
            // $(".calendarBox").each(function (index,element) {
            //     if($(".calendarBox").eq(index).is(':hidden')){
            //         $(".calendarBox").eq(index).hide();
            //     }
            // })
            $("#calendarOne").hide();
            $("#calendarTwo").hide();
            $("#calendarThree").hide();
            $("#calendarFour").hide();
        });
        laydate.render({
            elem: '#startDate',
            type: 'date',
            position: 'static',
            showBottom: false,
            theme: '#1FC0FC',
            ready: function (date) {
                $('#showStartDate').html(date.year + '-' + (date.month < 10 ? '0' + date.month : date.month) + '-' + (date.date < 10 ? '0' + date.date : date.date));
                startYear = date.year, startMonth = date.month, startDay = date.date
            },
            change: function (value, date) {
                $('#showStartDate').html(value);
            },
            done: function (value, date, endDate) {
                $(".calendarBox").hide();
                startYear = date.year, startMonth = date.month, startDay = date.date
            }
        });
        laydate.render({
            elem: '#startTime',
            type: 'time',
            position: 'static',
            showBottom: false,
            theme: '#1FC0FC',
            ready: function (date) {
                $('#showStartTime').html((date.hours < 10 ? '0' + date.hours : date.hours) + ':' + (date.minutes < 10 ? '0' + date.minutes : date.minutes) + ':' + (date.seconds < 10 ? '0' + date.seconds : date.seconds));
                startHour = date.hours, startMinute = date.minutes, startSecond = date.seconds
            },
            change: function (value, date) { //监听日期被切换
                $('#showStartTime').html(value);
                startHour = date.hours, startMinute = date.minutes, startSecond = date.seconds
            }
        });
        laydate.render({
            elem: '#endDate',
            type: 'date',
            position: 'static',
            showBottom: false,
            theme: '#1FC0FC',
            ready: function (date) {
                $('#showEndDate').html(date.year + '-' + (date.month < 10 ? '0' + date.month : date.month) + '-' + (date.date < 10 ? '0' + date.date : date.date));
                endYear = date.year, endMonth = date.month, endDay = date.date
                // // 初始化时间日期对象
                // var end_date = new Date(date.year, date.month - 1, date.date)
                // // 获取时间戳 -- 13 位
                // end_date_timestamp = end_date.getTime() / 1000
            },
            change: function (value, date) { //监听日期被切换
                $('#showEndDate').html(value);
            },
            done: function (value, date, endDate) {
                $(".calendarBox").hide();
                endYear = date.year, endMonth = date.month, endDay = date.date
            }
        });
        laydate.render({
            elem: '#endTime',
            type: 'time',
            position: 'static',
            showBottom: false,
            theme: '#1FC0FC',
            ready: function (date) {
                $('#showEndTime').html((date.hours < 10 ? '0' + date.hours : date.hours) + ':' + (date.minutes < 10 ? '0' + date.minutes : date.minutes) + ':' + (date.seconds < 10 ? '0' + date.seconds : date.seconds));
                endHour = date.hours, endMinute = date.minutes, endSecond = date.seconds
            },
            change: function (value, date) { //监听日期被切换
                $('#showEndTime').html(value);
                endHour = date.hours, endMinute = date.minutes, endSecond = date.seconds
            }
        });
    })
</script>
<script type="text/javascript">
    //-------------------海康视频调用-------------------

    //摄像头编号
    var gbCodes = getQueryVariable('cameraCode')
    var gbCodeArray = gbCodes.split(",");
    for(i =0;i<gbCodeArray.length;i++){
        var aHtml = '<a href="#" onclick="changeVideo(\''+gbCodeArray[i]+'\')">监控'+(i+1)+'</a>';
        $('.sidebarSubCon .alinksBox').append(aHtml);
        console.log(aHtml)
    }
    
    
    var gbCode = gbCodeArray[0];

    //页面加载时创建播放实例初始化
    $(window).load(function () {
        initPlugin()
    })

    //声明公用变量
    var initCount = 0
    var pubKey = ''

    var o = document.getElementById('videoDiv')
    var widthDiv = o.clientWidth || o.offsetWidth
    var heightDiv = o.clientHeight || o.offsetHeight

    // 创建播放实例
    function initPlugin() {
        oWebControl = new WebControl({
            szPluginContainer: 'playWnd', // 指定容器id
            iServicePortStart: 15900, // 指定起止端口号，建议使用该值
            iServicePortEnd: 15909,
            szClassId: '23BF3B0A-2C56-4D97-9C03-0CB103AA8F11', // 用于IE10使用ActiveX的clsid
            cbConnectSuccess: function () { // 创建WebControl实例成功
                oWebControl.JS_StartService('window', { // WebControl实例创建成功后需要启动服务
                    dllPath: './VideoPluginConnect.dll' // 值"./VideoPluginConnect.dll"写死
                }).then(function () { // 启动插件服务成功
                    oWebControl.JS_SetWindowControlCallback({ // 设置消息回调
                        cbIntegrationCallBack: cbIntegrationCallBack
                    })
                    oWebControl.JS_CreateWnd('contentVideo', widthDiv, heightDiv).then(
                        function () { //JS_CreateWnd创建视频播放窗口，宽高可设定
                            playVideo() // 创建播放实例成功后初始化
                        })
                }, function () { // 启动插件服务失败
                })
            },
            cbConnectError: function () { // 创建WebControl实例失败
                oWebControl = null
                $('#playWnd').html('插件未启动，正在尝试启动，请稍候...')
                WebControl.JS_WakeUp('VideoWebPlugin://') // 程序未启动时执行error函数，采用wakeup来启动程序
                initCount++
                if (initCount < 3) {
                    setTimeout(function () {
                        initPlugin()
                    }, 3000)
                } else {
                    $('#playWnd').html('插件启动失败，请检查插件是否安装！')
                }
            },
            cbConnectClose: function (bNormalClose) {
                // 异常断开：bNormalClose = false
                // JS_Disconnect正常断开：bNormalClose = true
                console.log('cbConnectClose')
                oWebControl = null
            }
        })
    }

    function changeVideo(nowCode){
        console.log('-------'+nowCode);
        gbCode=nowCode;
        playVideo();
    }

    //播放实时
    function playVideo() {
        //修改按钮样式
        $('#videoId').addClass('current')
        $('#recordId').removeClass('current')
        getPubKey(function () {
            //反初始化
            oWebControl.JS_RequestInterface({
                "funcName": "uninit"
            })
            ////////////////////////////////// 请自行修改以下变量值	////////////////////////////////////
            var appkey = '25823109' //综合安防管理平台提供的appkey，必填
            var secret = setEncrypt('qJfMVXvciP494OVlxBpI') //综合安防管理平台提供的secret，必填
            var ip = '58.221.12.43' //综合安防管理平台IP地址，必填
            var playMode = 0 //初始播放模式：0-预览，1-回放
            var port = 442 //综合安防管理平台端口，若启用HTTPS协议，默认443
            var snapDir = 'D:\\SnapDir' //抓图存储路径
            var videoDir = 'D:\\VideoDir' //紧急录像或录像剪辑存储路径
            var layout = '1x1' //playMode指定模式的布局
            var enableHTTPS = 1 //是否启用HTTPS协议与综合安防管理平台交互，这里总是填1
            var encryptedFields = 'secret' //加密字段，默认加密领域为secret
            var showToolbar = 0 //是否显示工具栏，0-不显示，非0-显示
            var showSmart = 0 //是否显示智能信息（如配置移动侦测后画面上的线框），0-不显示，非0-显示
            var buttonIDs = '0,16,256,257,258,259,260,512,513,514,515,516,517,768,769' //自定义工具条按钮
            ////////////////////////////////// 请自行修改以上变量值	////////////////////////////////////
            //初始化
            oWebControl.JS_RequestInterface({
                funcName: 'init',
                argument: JSON.stringify({
                    appkey: appkey, //API网关提供的appkey
                    secret: secret, //API网关提供的secret
                    ip: ip, //API网关IP地址
                    playMode: playMode, //播放模式（决定显示预览还是回放界面）
                    port: port, //端口
                    snapDir: snapDir, //抓图存储路径
                    videoDir: videoDir, //紧急录像或录像剪辑存储路径
                    layout: layout, //布局
                    enableHTTPS: enableHTTPS, //是否启用HTTPS协议
                    encryptedFields: encryptedFields, //加密字段
                    showToolbar: showToolbar, //是否显示工具栏
                    showSmart: showSmart, //是否显示智能信息
                    buttonIDs: buttonIDs //自定义工具条按钮
                })
            }).then(function () {
                //初始化后resize一次，规避firefox下首次显示窗口后插件窗口未与DIV窗口重合问题
                oWebControl.JS_Resize(widthDiv, heightDiv)
                // console.log(gbCode)
                //播放实时视频
                oWebControl.JS_RequestInterface({
                    funcName: 'startPreview',
                    argument: JSON.stringify({
                        cameraIndexCode: gbCode, //监控点编号
                        streamMode: 0, //主子码流标识
                        transMode: 0, //传输协议
                        gpuMode: 0, //是否开启GPU硬解
                        wndId: 1 //可指定播放窗口
                    })
                })
            })
        })
    }

    //播放录像
    function playRecord() {
        //修改样式
        $('#recordId').addClass('current')
        $('#videoId').removeClass('current')
        //获取回看时间
        var startDateTime = new Date(startYear, startMonth - 1, startDay, startHour, startMinute, startSecond)
        var endDateTime = new Date(endYear, endMonth - 1, endDay, endHour, endMinute, endSecond)
        //反初始化
        oWebControl.JS_RequestInterface({
            "funcName": "uninit"
        })
        ////////////////////////////////// 请自行修改以下变量值	////////////////////////////////////
        var appkey = '25823109' //综合安防管理平台提供的appkey，必填
        var secret = setEncrypt('qJfMVXvciP494OVlxBpI') //综合安防管理平台提供的secret，必填
        var ip = '58.221.12.43' //综合安防管理平台IP地址，必填
        var playMode = 1 //初始播放模式：0-预览，1-回放
        var port = 442 //综合安防管理平台端口，若启用HTTPS协议，默认443
        var snapDir = 'D:\\SnapDir' //抓图存储路径
        var videoDir = 'D:\\VideoDir' //紧急录像或录像剪辑存储路径
        var layout = '1x1' //playMode指定模式的布局
        var enableHTTPS = 1 //是否启用HTTPS协议与综合安防管理平台交互，这里总是填1
        var encryptedFields = 'secret' //加密字段，默认加密领域为secret
        var showToolbar = 0 //是否显示工具栏，0-不显示，非0-显示
        var showSmart = 0 //是否显示智能信息（如配置移动侦测后画面上的线框），0-不显示，非0-显示
        var buttonIDs = '0,16,256,257,258,259,260,512,513,514,515,516,517,768,769' //自定义工具条按钮
        ////////////////////////////////// 请自行修改以上变量值	////////////////////////////////////
        //重新初始化
        oWebControl.JS_RequestInterface({
            funcName: 'init',
            argument: JSON.stringify({
                appkey: appkey, //API网关提供的appkey
                secret: secret, //API网关提供的secret
                ip: ip, //API网关IP地址
                playMode: playMode, //播放模式（决定显示预览还是回放界面）
                port: port, //端口
                snapDir: snapDir, //抓图存储路径
                videoDir: videoDir, //紧急录像或录像剪辑存储路径
                layout: layout, //布局
                enableHTTPS: enableHTTPS, //是否启用HTTPS协议
                encryptedFields: encryptedFields, //加密字段
                showToolbar: showToolbar, //是否显示工具栏
                showSmart: showSmart, //是否显示智能信息
                buttonIDs: buttonIDs //自定义工具条按钮
            })
        }).then(function () {
            //初始化后resize一次，规避firefox下首次显示窗口后插件窗口未与DIV窗口重合问题
            oWebControl.JS_Resize(widthDiv, heightDiv)
            //播放回看
            oWebControl.JS_RequestInterface({
                funcName: 'startPlayback',
                argument: JSON.stringify({
                    cameraIndexCode: gbCode,  //监控点编号
                    startTimeStamp: Math.floor(startDateTime.getTime() / 1000).toString(),  //录像查询开始时间戳，单位：秒
                    endTimeStamp: Math.floor(endDateTime.getTime() / 1000).toString(),      //录像结束开始时间戳，单位：秒
                    recordLocation: 1,   //录像存储类型：0-中心存储，1-设备存储
                    transMode: 0,       //传输协议：0-UDP，1-TCP
                    gpuMode: 0,         //是否启用GPU硬解，0-不启用，1-启用
                    wndId: 1            //可指定播放窗口
                })
            })
        })
    }

    //获取公钥
    function getPubKey(callback) {
        oWebControl.JS_RequestInterface({
            funcName: 'getRSAPubKey',
            argument: JSON.stringify({
                keyLength: 1024
            })
        }).then(function (oData) {
            if (oData.responseMsg.data) {
                pubKey = oData.responseMsg.data
                callback()
            }
        })
    }

    //RSA加密
    function setEncrypt(value) {
        var encrypt = new JSEncrypt()
        encrypt.setPublicKey(pubKey)
        return encrypt.encrypt(value)
    }

    // 设置窗口控制回调
    function setCallbacks() {
        oWebControl.JS_SetWindowControlCallback({
            cbIntegrationCallBack: cbIntegrationCallBack
        })
    }

    // 推送消息
    function cbIntegrationCallBack(oData) {
        showCBInfo(JSON.stringify(oData.responseMsg))
    }

    // 标签关闭
    $(window).unload(function () {
        if (oWebControl != null) {
            oWebControl.JS_HideWnd() // 先让窗口隐藏，规避可能的插件窗口滞后于浏览器消失问题
            oWebControl.JS_Disconnect().then(function () {
                // 断开与插件服务连接成功
            }, function () {
                // 断开与插件服务连接失败
            })
        }
    })

    $(function () {
        window.onresize = function () {
            setTimeout(function () {
                var o2 = document.getElementById('videoDiv')
                var widthDiv2 = o2.clientWidth || o2.offsetWidth
                var heightDiv2 = o2.clientHeight || o2.offsetHeight
                oWebControl.JS_Resize(widthDiv2, heightDiv2)
            }, 100)
        }
    })

</script>
</body>

</html>